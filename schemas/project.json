{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Pictorigo Project Schema",
  "type": "object",
  "required": ["version", "world_points", "images", "cameras", "constraints"],
  "properties": {
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Schema version"
    },
    "world_points": {
      "type": "object",
      "additionalProperties": {
        "$ref": "#/definitions/WorldPoint"
      }
    },
    "images": {
      "type": "object",
      "additionalProperties": {
        "$ref": "#/definitions/Image"
      }
    },
    "cameras": {
      "type": "object",
      "additionalProperties": {
        "$ref": "#/definitions/Camera"
      }
    },
    "constraints": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/Constraint"
      }
    },
    "settings": {
      "$ref": "#/definitions/ProjectSettings"
    },
    "diagnostics": {
      "$ref": "#/definitions/SolveResult"
    }
  },
  "definitions": {
    "WorldPoint": {
      "type": "object",
      "required": ["id"],
      "properties": {
        "id": {
          "type": "string"
        },
        "xyz": {
          "type": "array",
          "items": {
            "type": "number"
          },
          "minItems": 3,
          "maxItems": 3,
          "description": "3D coordinates in meters [x, y, z]"
        }
      }
    },
    "Image": {
      "type": "object",
      "required": ["id", "path", "width", "height"],
      "properties": {
        "id": {
          "type": "string"
        },
        "path": {
          "type": "string",
          "description": "Path to image file"
        },
        "width": {
          "type": "integer",
          "minimum": 1
        },
        "height": {
          "type": "integer",
          "minimum": 1
        }
      }
    },
    "Camera": {
      "type": "object",
      "required": ["id", "image_id", "K", "R", "t"],
      "properties": {
        "id": {
          "type": "string"
        },
        "image_id": {
          "type": "string"
        },
        "K": {
          "type": "array",
          "items": {
            "type": "number"
          },
          "minItems": 5,
          "maxItems": 6,
          "description": "Intrinsics [fx, fy, cx, cy, k1, k2?]"
        },
        "R": {
          "type": "array",
          "items": {
            "type": "number"
          },
          "minItems": 3,
          "maxItems": 3,
          "description": "Rotation as axis-angle [rx, ry, rz]"
        },
        "t": {
          "type": "array",
          "items": {
            "type": "number"
          },
          "minItems": 3,
          "maxItems": 3,
          "description": "Translation [tx, ty, tz]"
        },
        "lock_flags": {
          "type": "object",
          "properties": {
            "intrinsics": {
              "type": "boolean"
            },
            "rotation": {
              "type": "boolean"
            },
            "translation": {
              "type": "boolean"
            }
          }
        }
      }
    },
    "Constraint": {
      "oneOf": [
        {
          "$ref": "#/definitions/ImagePointConstraint"
        },
        {
          "$ref": "#/definitions/KnownCoordConstraint"
        },
        {
          "$ref": "#/definitions/DistanceConstraint"
        },
        {
          "$ref": "#/definitions/AxisAlignConstraint"
        },
        {
          "$ref": "#/definitions/CoplanarConstraint"
        },
        {
          "$ref": "#/definitions/PlaneFromThreeConstraint"
        },
        {
          "$ref": "#/definitions/EqualityConstraint"
        },
        {
          "$ref": "#/definitions/GaugeFixConstraint"
        }
      ]
    },
    "ImagePointConstraint": {
      "type": "object",
      "required": ["type", "image_id", "wp_id", "u", "v"],
      "properties": {
        "type": {
          "const": "image_point"
        },
        "image_id": {
          "type": "string"
        },
        "wp_id": {
          "type": "string"
        },
        "u": {
          "type": "number"
        },
        "v": {
          "type": "number"
        },
        "sigma": {
          "type": "number",
          "minimum": 0,
          "default": 1.0
        }
      }
    },
    "KnownCoordConstraint": {
      "type": "object",
      "required": ["type", "wp_id", "mask_xyz", "values"],
      "properties": {
        "type": {
          "const": "known_coord"
        },
        "wp_id": {
          "type": "string"
        },
        "mask_xyz": {
          "type": "array",
          "items": {
            "type": "boolean"
          },
          "minItems": 3,
          "maxItems": 3
        },
        "values": {
          "type": "array",
          "items": {
            "type": "number"
          },
          "minItems": 3,
          "maxItems": 3
        }
      }
    },
    "DistanceConstraint": {
      "type": "object",
      "required": ["type", "wp_i", "wp_j", "distance"],
      "properties": {
        "type": {
          "const": "distance"
        },
        "wp_i": {
          "type": "string"
        },
        "wp_j": {
          "type": "string"
        },
        "distance": {
          "type": "number",
          "minimum": 0
        }
      }
    },
    "AxisAlignConstraint": {
      "type": "object",
      "required": ["type", "wp_i", "wp_j", "axis"],
      "properties": {
        "type": {
          "const": "axis_align"
        },
        "wp_i": {
          "type": "string"
        },
        "wp_j": {
          "type": "string"
        },
        "axis": {
          "oneOf": [
            {
              "enum": ["x", "y", "z", "-x", "-y", "-z"]
            },
            {
              "type": "array",
              "items": {
                "type": "number"
              },
              "minItems": 3,
              "maxItems": 3
            }
          ]
        }
      }
    },
    "CoplanarConstraint": {
      "type": "object",
      "required": ["type", "wp_ids"],
      "properties": {
        "type": {
          "const": "coplanar"
        },
        "wp_ids": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "minItems": 3
        }
      }
    },
    "PlaneFromThreeConstraint": {
      "type": "object",
      "required": ["type", "wp_a", "wp_b", "wp_c"],
      "properties": {
        "type": {
          "const": "plane_from_three"
        },
        "wp_a": {
          "type": "string"
        },
        "wp_b": {
          "type": "string"
        },
        "wp_c": {
          "type": "string"
        },
        "members": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Additional WPs constrained to this plane"
        }
      }
    },
    "EqualityConstraint": {
      "type": "object",
      "required": ["type", "wp_a", "wp_b"],
      "properties": {
        "type": {
          "const": "equality"
        },
        "wp_a": {
          "type": "string"
        },
        "wp_b": {
          "type": "string"
        }
      }
    },
    "GaugeFixConstraint": {
      "type": "object",
      "required": ["type", "origin_wp", "x_wp", "xy_wp", "scale_d"],
      "properties": {
        "type": {
          "const": "gauge_fix"
        },
        "origin_wp": {
          "type": "string"
        },
        "x_wp": {
          "type": "string"
        },
        "xy_wp": {
          "type": "string"
        },
        "scale_d": {
          "type": "number",
          "minimum": 0
        }
      }
    },
    "ProjectSettings": {
      "type": "object",
      "properties": {
        "solver": {
          "type": "object",
          "properties": {
            "max_iterations": {
              "type": "integer",
              "minimum": 1,
              "default": 100
            },
            "tolerance": {
              "type": "number",
              "minimum": 0,
              "default": 1e-6
            },
            "robust_loss": {
              "enum": ["none", "huber", "cauchy"],
              "default": "huber"
            }
          }
        }
      }
    },
    "SolveResult": {
      "type": "object",
      "properties": {
        "success": {
          "type": "boolean"
        },
        "iterations": {
          "type": "integer"
        },
        "final_cost": {
          "type": "number"
        },
        "residuals": {
          "type": "object",
          "additionalProperties": {
            "type": "number"
          }
        },
        "uncertainties": {
          "type": "object",
          "additionalProperties": {
            "type": "array",
            "items": {
              "type": "number"
            },
            "minItems": 3,
            "maxItems": 3
          }
        },
        "unconstrained_dofs": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    }
  }
}