CAMERA AND WORLD POINT INITIALIZATION DURING OPTIMIZATION
===========================================================

This document summarizes the findings from analyzing the Pictorigo codebase.

KEY FINDINGS
============

1. WORLD POINT INITIALIZATION - Unified 6-Step Pipeline
   Location: src/optimization/unified-initialization.ts
   
   Step 1: Set locked points (user-defined coordinates)
   Step 2: Infer from constraints (line direction + length)
   Step 3: Triangulate from images (ray-ray for 2+ cameras)
   Step 4: Propagate through line graph (BFS from initialized)
   Step 5: Coplanar groups (grid on parallel planes)
   Step 6: Random fallback (uniform cube)
   
   Each step initializes more points, building on previous results.
   All 6 steps run sequentially in initializeWorldPoints().

2. CAMERA INITIALIZATION - Two Strategies
   
   Strategy A: PnP (Perspective-n-Point)
   - Location: src/optimization/pnp.ts
   - Requirements: 4+ world points with optimizedXyz visible
   - Process:
     1. Geometric guess: place camera 2.5x max-distance from centroid
     2. Refine: bundle adjustment with world points FIXED
     3. Report error metrics
   - When used: After world points initialized, for each uninitialized camera
   
   Strategy B: Essential Matrix
   - Location: src/optimization/essential-matrix.ts
   - Requirements: 8+ point correspondences between 2 cameras
   - Process:
     1. 8-point algorithm to estimate E matrix
     2. SVD decompose into 4 possible (R,t) pairs
     3. Cheirality test: select pair with most points in front
     4. Set both camera poses
   - When used: If no locked points available, before PnP

3. SCENE SCALE PARAMETERS
   
   Scene Scale (10.0)
   - Used in world point initialization
   - Bounds random point placement
   - Scale for line propagation (sceneScale * 0.2)
   - Spacing for coplanar grids (sceneScale / gridSize)
   
   Baseline Scale (10.0)
   - Used in Essential Matrix to scale translation
   - Translation direction is always unit vector
   - BaselineScale scales it to metric units
   - Can be calibrated from known camera distances

4. INTEGRATION IN optimize-project.ts
   
   Flow:
   a. Initialize world points (all 6 steps)
   b. Initialize cameras:
      - Try PnP with locked points (if 4+ visible)
      - Try Essential Matrix (if 2+ uninitialized cameras)
      - Try PnP with triangulated points
   c. Create ConstraintSystem
   d. Add all entities (points, lines, cameras, imagepoints, constraints)
   e. Run system.solve() (main optimization)
   f. Detect outliers (adaptive threshold)

5. TRIANGULATION ALGORITHM
   
   Ray-ray triangulation (in src/optimization/triangulation.ts):
   - Convert image coords to camera-frame rays
   - Rotate rays to world space using camera rotation
   - Solve closest point on two skew lines
   - Place world point at midpoint
   
   Fallback for degenerate cases (parallel rays):
   - Use fallbackDepth = 10.0 along both rays

KEY DATA STRUCTURES
===================

World Point:
  - lockedXyz: [number, number, number]? (user-locked values)
  - optimizedXyz: [number, number, number] (computed position)
  - imagePoints: Set<ImagePoint> (observations)
  - isFullyLocked(): boolean

Line:
  - pointA, pointB: WorldPoint
  - targetLength?: number (distance constraint)
  - direction?: string ("x-aligned", "vertical", "z-aligned", "horizontal", "free")

Viewpoint (Camera):
  - position: [number, number, number] (3D location)
  - rotation: [number, number, number, number] (quaternion)
  - imagePoints: Set<ImagePoint> (observations)
  - focalLength, principalPoint, aspect ratio, distortion parameters

ImagePoint:
  - u, v: number (pixel coordinates)
  - worldPoint: WorldPoint
  - viewpoint: Viewpoint
  - lastResiduals?: [number, number] (for outlier detection)

Constraint:
  - getConstraintType(): string
  - Examples: "projection_point_camera", "coplanar_points", "parallel_lines"

PROJECT STRUCTURE
=================

Initialization Code:
  src/optimization/unified-initialization.ts  (6-step pipeline)
  src/optimization/pnp.ts                     (PnP camera init)
  src/optimization/essential-matrix.ts        (Essential matrix init)
  src/optimization/triangulation.ts           (Ray-ray triangulation)

Integration:
  src/optimization/optimize-project.ts        (Main orchestrator)
  src/components/OptimizationPanel.tsx        (UI controls)

Solver:
  src/optimization/constraint-system.ts       (Main optimization loop)
  src/optimization/camera-projection.ts       (Reprojection math)

CONSOLE OUTPUT EXAMPLES
=======================

World Point Initialization:
  [Unified Initialization] Starting 6-step initialization...
  [Step 1] Set 2 locked points
  [Step 2] Inferred 5 points from constraints
  [Step 3] Triangulated 8 new points (3 failed)
  [Step 4] Propagated 12 points through line graph
  [Step 5] Initialized 3 points in 1 coplanar group
  [Step 6] Random fallback for 4 points
  [Unified Initialization] Complete: 34/34 points initialized

PnP Camera Initialization:
  PnP: Initialized Camera1 using 15 points
    Centroid of 15 points: [5.234, -2.100, 8.567]
    Max distance from centroid: 12.450
    Computed camera distance: 31.125
    Initial camera position: [5.234, -2.100, -22.558]
    Initial reprojection error: 45.23 px
    Final reprojection error: 2.15 px (47 iterations)
    Position: [5.234, -2.100, -22.558]

Essential Matrix:
  [Essential Matrix] Found 24 correspondences
  [Essential Matrix] E matrix: [...]
  [Essential Matrix] Verifying epipolar constraint...
  [Essential Matrix] Cheirality test for 4 decompositions:
    Solution 1: 24/24 points in front
    Solution 2: 2/24 points in front
    Solution 3: 0/24 points in front
    Solution 4: 18/24 points in front
    Selected solution with 24 points in front
  [Essential Matrix] Camera poses after initialization:
    Camera 1: pos=[0, 0, 0], rot=[1, 0, 0, 0]
    Camera 2: pos=[5.234, -1.100, 8.300], rot=[...]

COMMON ISSUES
=============

Issue: "PnP: Need at least 4 points with optimizedXyz"
Solution: Ensure world point initialization ran first, or add locked points

Issue: "Essential Matrix: Need at least 8 correspondences"
Solution: Add more image observations or use different camera pair

Issue: High reprojection errors after initialization
Solution: Check image point accuracy, add constraints, improve correspondences

Issue: Optimization doesn't converge
Solution: Better initialization, add locked points, improve constraints

RECOMMENDATIONS FOR INTEGRATION
================================

1. Always run world point initialization first (6-step pipeline)
2. Use PnP when possible (requires fewer setup than Essential Matrix)
3. Use Essential Matrix as fallback when no pre-initialized cameras
4. Verify camera poses make geometric sense (cheirality test confirms this)
5. Monitor reprojection error to detect matching errors
6. Add locked points/constraints to guide initialization

For more details, see:
  INITIALIZATION_STRATEGY.md        (High-level overview)
  INITIALIZATION_ALGORITHMS_PART1.md (Step-by-step algorithms)

